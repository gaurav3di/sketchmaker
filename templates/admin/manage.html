{% extends "base.html" %}

{% block title %}Manage Users{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <div class="flex flex-col gap-6">
        <!-- Header -->
        <div class="flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold">User Management</h1>
                <p class="text-base-content/70">Total Users: {{ total_users }}</p>
            </div>
            <div class="flex gap-4">
                <!-- Search -->
                <div class="form-control">
                    <div class="input-group">
                        <input type="text" id="searchInput" placeholder="Search users..." class="input input-bordered w-64" value="{{ search_query }}">
                        <button class="btn btn-square" onclick="searchUsers()">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z" />
                            </svg>
                        </button>
                    </div>
                </div>
                <!-- Add User Button -->
                <button class="btn btn-primary" onclick="document.getElementById('add-user-modal').showModal()">Add User</button>
            </div>
        </div>

        <!-- Settings Card -->
        <div class="card bg-base-200">
            <div class="card-body">
                <h2 class="card-title">System Settings</h2>
                <div class="form-control">
                    <label class="label cursor-pointer">
                        <span class="label-text">Require Manual Approval for New Users</span>
                        <input type="checkbox" class="toggle toggle-primary" 
                               {% if settings.require_manual_approval %}checked{% endif %}
                               onchange="updateApprovalSetting(this.checked)" />
                    </label>
                </div>
            </div>
        </div>

        <!-- Users Table -->
        <div class="overflow-x-auto">
            <table class="table table-zebra w-full">
                <thead>
                    <tr>
                        <th>Username</th>
                        <th>Email</th>
                        <th>Role</th>
                        <th>Status</th>
                        <th>Approval</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for user in users %}
                    <tr>
                        <td>{{ user.username }}</td>
                        <td>{{ user.email }}</td>
                        <td>
                            <span class="badge {% if user.is_superadmin() %}badge-secondary{% elif user.is_admin() %}badge-primary{% else %}badge-ghost{% endif %}">
                                {{ user.role }}
                            </span>
                        </td>
                        <td>
                            <span class="badge {% if user.is_active %}badge-success{% else %}badge-error{% endif %}">
                                {{ 'Active' if user.is_active else 'Inactive' }}
                            </span>
                        </td>
                        <td>
                            <span class="badge {% if user.is_approved %}badge-success{% else %}badge-warning{% endif %}">
                                {{ 'Approved' if user.is_approved else 'Pending' }}
                            </span>
                        </td>
                        <td>
                            <div class="flex gap-2">
                                {% if not user.is_superadmin() or current_user.is_superadmin() %}
                                    <!-- Role Management -->
                                    <div class="dropdown dropdown-end">
                                        <label tabindex="0" class="btn btn-sm">Role</label>
                                        <ul tabindex="0" class="dropdown-content z-[1] menu p-2 shadow bg-base-100 rounded-box w-52">
                                            {% if current_user.is_superadmin() %}
                                                <li>
                                                    <form action="{{ url_for('admin.update_user', user_id=user.id) }}" method="POST" class="w-full">
                                                        <input type="hidden" name="action" value="toggle_role">
                                                        <input type="hidden" name="role" value="user">
                                                        <button type="submit" class="w-full text-left">Set as User</button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <form action="{{ url_for('admin.update_user', user_id=user.id) }}" method="POST" class="w-full">
                                                        <input type="hidden" name="action" value="toggle_role">
                                                        <input type="hidden" name="role" value="admin">
                                                        <button type="submit" class="w-full text-left">Set as Admin</button>
                                                    </form>
                                                </li>
                                                <li>
                                                    <form action="{{ url_for('admin.update_user', user_id=user.id) }}" method="POST" class="w-full">
                                                        <input type="hidden" name="action" value="toggle_role">
                                                        <input type="hidden" name="role" value="superadmin">
                                                        <button type="submit" class="w-full text-left">Set as Superadmin</button>
                                                    </form>
                                                </li>
                                            {% else %}
                                                <li>
                                                    <form action="{{ url_for('admin.update_user', user_id=user.id) }}" method="POST" class="w-full">
                                                        <input type="hidden" name="action" value="toggle_role">
                                                        <button type="submit" class="w-full text-left">Toggle Admin</button>
                                                    </form>
                                                </li>
                                            {% endif %}
                                        </ul>
                                    </div>

                                    <!-- Status Toggle -->
                                    <form action="{{ url_for('admin.update_user', user_id=user.id) }}" method="POST" class="inline">
                                        <input type="hidden" name="action" value="toggle_status">
                                        <button type="submit" class="btn btn-sm {% if user.is_active %}btn-error{% else %}btn-success{% endif %}">
                                            {{ 'Deactivate' if user.is_active else 'Activate' }}
                                        </button>
                                    </form>

                                    <!-- Approval Toggle -->
                                    <form action="{{ url_for('admin.update_user', user_id=user.id) }}" method="POST" class="inline">
                                        <input type="hidden" name="action" value="toggle_approval">
                                        <button type="submit" class="btn btn-sm {% if user.is_approved %}btn-warning{% else %}btn-success{% endif %}">
                                            {{ 'Unapprove' if user.is_approved else 'Approve' }}
                                        </button>
                                    </form>

                                    <!-- Password Reset -->
                                    <button class="btn btn-sm btn-info" 
                                            onclick="document.getElementById('reset-password-modal-{{ user.id }}').showModal()">
                                        Reset Password
                                    </button>

                                    <!-- Delete User -->
                                    <form action="{{ url_for('admin.update_user', user_id=user.id) }}" method="POST" 
                                          class="inline" onsubmit="return confirm('Are you sure you want to delete user {{ user.username }}?')">
                                        <input type="hidden" name="action" value="delete">
                                        <button type="submit" class="btn btn-sm btn-error">Delete</button>
                                    </form>
                                {% endif %}
                            </div>
                        </td>
                    </tr>

                    <!-- Password Reset Modal -->
                    <dialog id="reset-password-modal-{{ user.id }}" class="modal">
                        <div class="modal-box">
                            <h3 class="font-bold text-lg">Reset Password for {{ user.username }}</h3>
                            <form action="{{ url_for('admin.update_user', user_id=user.id) }}" method="POST">
                                <input type="hidden" name="action" value="set_password">
                                <div class="form-control">
                                    <label class="label">
                                        <span class="label-text">New Password</span>
                                    </label>
                                    <input type="password" name="new_password" class="input input-bordered" required>
                                </div>
                                <div class="modal-action">
                                    <button type="submit" class="btn btn-primary">Reset Password</button>
                                    <button type="button" class="btn" onclick="document.getElementById('reset-password-modal-{{ user.id }}').close()">Cancel</button>
                                </div>
                            </form>
                        </div>
                    </dialog>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Add User Modal -->
<dialog id="add-user-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg">Add New User</h3>
        <form action="{{ url_for('admin.add_user') }}" method="POST">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Username</span>
                </label>
                <input type="text" name="username" class="input input-bordered" required>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Email</span>
                </label>
                <input type="email" name="email" class="input input-bordered" required>
            </div>
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Password</span>
                </label>
                <input type="password" name="password" class="input input-bordered" required>
            </div>
            {% if current_user.is_superadmin() %}
            <div class="form-control">
                <label class="label">
                    <span class="label-text">Role</span>
                </label>
                <select name="role" class="select select-bordered">
                    <option value="user">User</option>
                    <option value="admin">Admin</option>
                    <option value="superadmin">Superadmin</option>
                </select>
            </div>
            {% endif %}
            <div class="modal-action">
                <button type="submit" class="btn btn-primary">Add User</button>
                <button type="button" class="btn" onclick="document.getElementById('add-user-modal').close()">Cancel</button>
            </div>
        </form>
    </div>
</dialog>

<!-- Toast Container -->
<div id="toast-container" class="toast toast-end"></div>

<script>
function showToast(message, type = 'info') {
    const toast = document.createElement('div');
    toast.className = `alert ${type === 'error' ? 'alert-error' : type === 'success' ? 'alert-success' : 'alert-info'}`;
    toast.innerHTML = `
        <span>${message}</span>
        <button onclick="this.parentElement.remove()" class="btn btn-ghost btn-xs">✕</button>
    `;
    
    const container = document.getElementById('toast-container');
    container.appendChild(toast);
    
    // Auto remove after 5 seconds
    setTimeout(() => {
        if (toast.parentElement) {
            toast.remove();
        }
    }, 5000);
}

function searchUsers() {
    const query = document.getElementById('searchInput').value;
    window.location.href = "{{ url_for('admin.manage') }}?search=" + encodeURIComponent(query);
}

document.getElementById('searchInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        searchUsers();
    }
});

async function updateApprovalSetting(checked) {
    try {
        const response = await fetch("{{ url_for('admin.update_settings') }}", {
            method: 'POST',
            headers: {
                'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `require_manual_approval=${checked}`
        });
        
        const data = await response.json();
        showToast(data.message, data.success ? 'success' : 'error');
    } catch (error) {
        console.error('Error:', error);
        showToast('Failed to update settings', 'error');
    }
}

// Add event listeners to all forms to show toast messages
document.addEventListener('DOMContentLoaded', function() {
    const forms = document.querySelectorAll('form');
    forms.forEach(form => {
        form.addEventListener('submit', async function(e) {
            e.preventDefault();
            
            try {
                const response = await fetch(this.action, {
                    method: this.method,
                    body: new FormData(this)
                });
                
                const data = await response.json();
                showToast(data.message, data.success ? 'success' : 'error');
                
                if (data.success) {
                    // Close any open modals
                    document.querySelectorAll('.modal').forEach(modal => modal.close());
                    // Reload the page to show updated data
                    location.reload();
                }
            } catch (error) {
                console.error('Error:', error);
                showToast('An error occurred while processing your request', 'error');
            }
        });
    });
});
</script>
{% endblock %}
